# protoc-gen-stest

This is a protoc plugin which generates golang source code for gRPC scenario test.
The plugin can test the gRPC methods defined in your .proto file.
The necessary preparation is the source code that calls the test using your .proto file and the JSON file that defines the test scenario, and the simple gRPC service client and testing package.

To use this plugin, you need to use [protoc-gen-go](https://github.com/golang/protobuf/tree/master/protoc-gen-go) to generate Golang source code.

# Installation

```
go get -u github.com/yoshd/protoc-gen-stest
```


# Invoking the Plugin

```
protoc -I. --plugin=path/to/protoc-gen-stest --stest_out=. your.proto
```

# Usage

## the simple example

See [examples](examples/)

* Suppose you have the following yoshd.proto:

```protobuf
syntax = "proto3";

option go_package = "pb";

service Yoshd {
    rpc Yoshi (YoshiRequest) returns (YoshiResponse) {
    }
}

message YoshiRequest {
    string req_msg = 1;
}
message YoshiResponse {
    string res_msg = 1;
}
```

* Generate source codes.

```
protoc -I. --plugin=path/to/protoc-gen-stest --go_out=plugins=grpc:pb --stest_out=pb your.proto
```

* By creating the following JSON file, you can test by calling the Yoshi method twice.
    * For action, write gRPC method name.
    * For request, write request parameters.
    * For expected_response, write the value of the expected response. If you expect error response, you do not need to write it.
    * For error_expectation, write whether or not to expect an error response. At the moment it is necessary to write true or false.
    * For expected_error_code, write the expected gPRC error code as a numerical value.

The field names of the request and response are the same as those of the JSON tag attached to the structure of the code generated by [protoc-gen-go](https://github.com/golang/protobuf/tree/master/protoc-gen-go).

```json
[
    {
        "action": "Yoshi",
        "request": {
            "req_msg": "Yoshi!"
        },
        "expected_response": {
            "res_msg": "YoshiYoshi!"
        },
        "error_expectation": false
    },
    {
        "action": "Yoshi",
        "request": {
            "req_msg": "Yoshi"
        },
        "error_expectation": true,
        "expected_error_code": 3
    }
]
```

* Write gRPC client, code to compare expected response and actual response, test call in Golang.
    * The default behavior is to compare expected response and actual response with reflect.DeepEqual

```go
package examples

import (
	"testing"

	"github.com/yoshd/protoc-gen-stest/examples/pb"

	"google.golang.org/grpc"
)

func TestScenario(t *testing.T) {
	target := "localhost:13009"
	client, _ := grpc.Dial(target, grpc.WithInsecure())
	defer client.Close()

	yoshd := pb.NewYoshdClient(client)
	testClient := pb.NewTestClient(yoshd)
	testClient.RunGRPCTest(
		t,
		"path/to/yoshd.json",
		nil,
	)
}
```

* If you want to specify how you want to compare the expected response to the actual response, you need the code on how to handle the test.
    * For the key of testHandlerMap, specify the gRPC method name, and for the value specify the function describing the comparison of the expected response and the actual response and handling of the test.

```go
package examples

import (
	"testing"

	"github.com/stretchr/testify/assert"
	"github.com/yoshd/protoc-gen-stest/examples/pb"

	"google.golang.org/grpc"
)

var testHandlerMap = map[string]*func(t *testing.T, expectedResponse, response interface{}){}

func TestScenario(t *testing.T) {
	target := "localhost:13009"
	client, _ := grpc.Dial(target, grpc.WithInsecure())
	defer client.Close()

	yoshd := pb.NewYoshdClient(client)
	testClient := pb.NewTestClient(yoshd)
	testClient.RunGRPCTest(
		t,
		"path/to/yoshd.json",
		testHandlerMap,
	)
}

func setUp() {
    // How to compare the expected response with the actual response and write how to handle the test
	YoshiTestHandler := func(t *testing.T, expectedResponse, response interface{}) {
		if expectedResponse == nil || response == nil {
			return
		}
		er := expectedResponse.(pb.YoshiResponse)
		r := response.(pb.YoshiResponse)
		assert.Equal(t, er.ResMsg, r.ResMsg)
	}
	testHandlerMap["Yoshi"] = &YoshiTestHandler
}

func TestMain(m *testing.M) {
	setUp()
	m.Run()
}
```

* Run the test

```
go test -v yoshd_test.go
```
